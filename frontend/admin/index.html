<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Admin - Shoopaholic</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="sidebar">
    <h2>üõçÔ∏è Shoopaholic</h2>
    <nav>
        <button onclick="scrollToTop()">üõ†Ô∏è Manager</button>
        <button onclick="scrollToAnalytics()">üìä Analytics</button>
    </nav>
    <div style="margin-top: auto; padding: 20px;">
      <a href="../chat/" class="link-btn" target="_blank">Open Customer Chat ‚Üó</a>
    </div>
</div>

<div class="main-content">
    
    <!-- TOP HEADER -->
    <div class="page-header">
        <h3>Shop Dashboard</h3>
        <button class="btn-success" onclick="syncToAI()">‚ú® Sync All to AI</button>
    </div>

    <!-- MAIN SPLIT VIEW (Manager vs Inventory) -->
    <div class="split-layout">
        
        <!-- LEFT COLUMN: MANAGERS (Inputs) -->
        <div class="left-panel">
            
            <!-- 1. Shop Configuration -->
            <div class="card form-card mb-20">
                <h4>üè™ Shop Configuration</h4>
                <div class="form-group">
                    <label>Shop Name</label>
                    <input type="text" id="shop-name" placeholder="e.g. Benny's Boutique">
                </div>
                <div class="form-group">
                    <label>Policies / Opening Hours</label>
                    <textarea id="shop-policy" placeholder="Open 9-5. No returns on socks."></textarea>
                </div>
            </div>

            <!-- 2. Item Manager -->
            <div class="card form-card">
                <div class="type-toggle">
                    <label class="toggle-opt">
                        <input type="radio" name="itemType" value="product" checked onchange="toggleForm()">
                        <span>Product</span>
                    </label>
                    <label class="toggle-opt">
                        <input type="radio" name="itemType" value="promo" onchange="toggleForm()">
                        <span>Promotion</span>
                    </label>
                </div>

                <h4 id="form-title">Add New Product</h4>
                
                <div class="form-group">
                    <label>Title / Name</label>
                    <input type="text" id="item-name">
                </div>
                
                <!-- Conditional Fields -->
                <div id="product-fields">
                    <div class="form-group">
                        <label>Price</label>
                        <input type="text" id="item-price" placeholder="$0.00">
                    </div>
                    <div class="form-group">
                        <label>Image URL</label>
                        <input type="text" id="item-img" placeholder="http://...">
                    </div>
                </div>

                <div class="form-group">
                    <label>Description / Details</label>
                    <textarea id="item-desc"></textarea>
                </div>
                
                <button class="btn-primary" onclick="addItem()">Add Item</button>
            </div>
        </div>
        
        <!-- RIGHT COLUMN: INVENTORY (Display) -->
        <div class="right-panel">
            <div class="card carousel-container">
                <div class="carousel-tabs">
                    <button id="tab-prod" class="active" onclick="setViewMode('products')">Products (<span id="count-prod">0</span>)</button>
                    <button id="tab-promo" onclick="setViewMode('promos')">Promos (<span id="count-promo">0</span>)</button>
                </div>

                <div id="slide-view" class="slide-view">
                    <!-- Injected JS Content -->
                </div>

                <div class="carousel-controls">
                    <button onclick="prevSlide()">Previous</button>
                    <button onclick="nextSlide()">Next</button>
                </div>
            </div>
        </div>
    </div>
    <div id="status-msg"></div>

    <!-- SECTION 3: ANALYTICS (With Padding) -->
    <div id="analytics-section" class="section">
        <h3>Insights & Recommendations</h3>
        <div class="analytics-grid">
            <div class="card stats-card">
                <div class="stat-number" id="total-queries">0</div>
                <div class="stat-label">Total Questions Asked</div>
            </div>
            <div class="card" style="grid-column: span 2;">
                <h4>üí° AI Recommendations</h4>
                <ul id="recommendations-list" class="reco-list"><li>Loading...</li></ul>
            </div>
            <div class="card" style="grid-column: span 3;">
                <h4>Top Customer Interests</h4>
                <canvas id="keywordsChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>

</div>

<script>
    const API_URL = "http://localhost:8000";
    
    // State
    let products = JSON.parse(localStorage.getItem('products')) || [];
    let promos = JSON.parse(localStorage.getItem('promos')) || [];
    let shopInfo = JSON.parse(localStorage.getItem('shopInfo')) || { name: "", policy: "" };
    
    // UI State
    let currentIdx = 0;
    let viewMode = 'products'; // 'products' or 'promos'

    window.onload = () => {
        document.getElementById('shop-name').value = shopInfo.name;
        document.getElementById('shop-policy').value = shopInfo.policy;
        
        // Auto-save shop details
        ['shop-name', 'shop-policy'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => {
                shopInfo.name = document.getElementById('shop-name').value;
                shopInfo.policy = document.getElementById('shop-policy').value;
                localStorage.setItem('shopInfo', JSON.stringify(shopInfo));
            });
        });

        renderSlide();
        loadAnalytics();
    };

    function scrollToTop() {
        document.querySelector('.main-content').scrollTo({ top: 0, behavior: 'smooth' });
    }

    function scrollToAnalytics() {
        document.getElementById('analytics-section').scrollIntoView({ behavior: 'smooth' });
    }

    // --- FORM LOGIC ---
    function toggleForm() {
        const type = document.querySelector('input[name="itemType"]:checked').value;
        const prodFields = document.getElementById('product-fields');
        const title = document.getElementById('form-title');

        if (type === 'product') {
            prodFields.style.display = 'block';
            title.innerText = "Add New Product";
        } else {
            prodFields.style.display = 'none';
            title.innerText = "Add New Promotion";
        }
    }

    function addItem() {
        const type = document.querySelector('input[name="itemType"]:checked').value;
        const name = document.getElementById('item-name').value;
        const desc = document.getElementById('item-desc').value;

        if (!name) return alert("Name/Title is required");

        if (type === 'product') {
            products.push({
                id: Date.now(),
                name,
                price: document.getElementById('item-price').value,
                img: document.getElementById('item-img').value,
                desc
            });
            viewMode = 'products';
        } else {
            promos.push({
                id: Date.now(),
                title: name,
                desc
            });
            viewMode = 'promos';
        }

        save();
        currentIdx = (viewMode === 'products' ? products.length : promos.length) - 1;
        renderSlide();
        
        // Clear Inputs
        document.getElementById('item-name').value = '';
        document.getElementById('item-price').value = '';
        document.getElementById('item-img').value = '';
        document.getElementById('item-desc').value = '';
    }

    function removeItem() {
        let list = viewMode === 'products' ? products : promos;
        if (list.length === 0) return;
        
        list.splice(currentIdx, 1);
        if (currentIdx >= list.length) currentIdx = Math.max(0, list.length - 1);
        
        save();
        renderSlide();
    }

    // --- CAROUSEL LOGIC ---
    function setViewMode(mode) {
        viewMode = mode;
        currentIdx = 0;
        renderSlide();
    }

    function nextSlide() {
        let list = viewMode === 'products' ? products : promos;
        if (currentIdx < list.length - 1) {
            currentIdx++;
            renderSlide();
        }
    }

    function prevSlide() {
        if (currentIdx > 0) {
            currentIdx--;
            renderSlide();
        }
    }

    function renderSlide() {
        // Update Tabs
        document.getElementById('tab-prod').className = viewMode === 'products' ? 'active' : '';
        document.getElementById('tab-promo').className = viewMode === 'promos' ? 'active' : '';
        document.getElementById('count-prod').innerText = products.length;
        document.getElementById('count-promo').innerText = promos.length;

        const container = document.getElementById('slide-view');
        let list = viewMode === 'products' ? products : promos;

        if (list.length === 0) {
            container.innerHTML = `<p class="empty-state">No items found.</p>`;
            return;
        }

        const item = list[currentIdx];
        
        if (viewMode === 'products') {
            const hasImg = item.img && item.img.length > 5;
            container.innerHTML = `
                <div class="slide-card fade-in">
                    <div class="slide-img-container">
                        ${hasImg ? `<img src="${item.img}" onerror="this.style.display='none'">` : '<div class="no-img">No Image</div>'}
                    </div>
                    <div class="slide-content">
                        <h3>${item.name}</h3>
                        <div class="slide-price">${item.price}</div>
                        <p>${item.desc}</p>
                        <button class="delete-btn-slide" onclick="removeItem()">Delete Product</button>
                    </div>
                    <div class="slide-counter">${currentIdx + 1} / ${products.length}</div>
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="slide-card fade-in promo-card-style">
                    <div class="slide-content" style="text-align:center; padding: 40px; display:flex; flex-direction:column; justify-content:center; height:100%">
                        <span style="font-size:3rem;">üè∑Ô∏è</span>
                        <h3 style="color:#f59e0b; font-size: 1.5rem; margin: 10px 0;">${item.title}</h3>
                        <p style="font-size: 1.2rem;">${item.desc}</p>
                        <button class="delete-btn-slide" onclick="removeItem()">Delete Promo</button>
                    </div>
                    <div class="slide-counter">${currentIdx + 1} / ${promos.length}</div>
                </div>
            `;
        }
    }

    function save() {
        localStorage.setItem('products', JSON.stringify(products));
        localStorage.setItem('promos', JSON.stringify(promos));
    }

    // --- SYNC & ANALYTICS ---
    async function syncToAI() {
        const btn = document.querySelector('.btn-success');
        const msg = document.getElementById('status-msg');
        
        let textBlob = `SHOP INFO:\nName: ${shopInfo.name}\nPolicies: ${shopInfo.policy}\n\nCATALOG:\n`;
        products.forEach(p => textBlob += `Product: ${p.name}, Price: ${p.price}, Details: ${p.desc}, Image: ${p.img}\n`);
        textBlob += "\nPROMOTIONS:\n";
        promos.forEach(p => textBlob += `Promo: ${p.title} - ${p.desc}\n`);

        btn.innerText = "Syncing..."; btn.disabled = true;
        try {
            const res = await fetch(`${API_URL}/admin/update_knowledge`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ shop_data_text: textBlob })
            });
            if(res.ok) { msg.innerText = "‚úÖ Brain Updated!"; setTimeout(()=>msg.innerText="", 3000); }
        } catch(e) { msg.innerText = "Error connecting."; }
        btn.innerText = "‚ú® Sync All to AI"; btn.disabled = false;
    }

    async function loadAnalytics() {
        try {
            const res = await fetch(`${API_URL}/admin/analytics`);
            const data = await res.json();
            document.getElementById('total-queries').innerText = data.total_queries;
            
            const ctx = document.getElementById('keywordsChart');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.top_keywords.map(k => k[0]),
                    datasets: [{ label: 'Questions', data: data.top_keywords.map(k => k[1]), backgroundColor: '#2563eb' }]
                }
            });

            const recRes = await fetch(`${API_URL}/admin/recommendations`);
            const recData = await recRes.json();
            document.getElementById('recommendations-list').innerHTML = recData.msgs.map(m => `<li>${m}</li>`).join('');
        } catch(e) { console.error(e); }
    }
</script>
</body>
</html>